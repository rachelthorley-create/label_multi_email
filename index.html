<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Label Generator & Renderer</title>

<!-- JSZip for SVG download -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.0/jszip.min.js"></script>

<style>
  body { font-family: Arial, Helvetica, sans-serif; margin: 18px; display: flex; flex-direction: column; align-items: center; }
  #allPreviews { display: flex; flex-direction: column; gap: 20px; margin-top: 10px; }
  canvas { width: 378px; height: 283px; border: 1px solid #ccc; border-radius: 6px; }
  #advancedOptions { display: none; margin-top: 10px; border: 1px solid #aaa; padding: 10px; border-radius: 6px; }
  .button-row { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
  input, select { margin-bottom: 6px; }
</style>
</head>
<body>

<h2>Label Generator & Renderer v1.1</h2>

<!-- Form for Name and Email -->
<div>
  <input type="text" id="name" placeholder="Your Name">
  <input type="email" id="email" placeholder="Your Email">
</div>

<!-- File Upload -->
<input type="file" id="uploadLabel" accept=".json">

<!-- Buttons -->
<div class="button-row">
  <button id="previewBtn">Preview Labels</button>
  <button id="downloadBtn">Download All SVGs (ZIP)</button>
  <button id="toggleAdvanced">Show Advanced Options</button>
  <button id="submitBtn">Submit to Google Sheet</button>
</div>

<!-- Advanced Options -->
<div id="advancedOptions">
  <!-- example options -->
  <label>Text Shift (mm): <input type="number" id="textShift" value="0"></label><br>
  <label>Gap 1-2 (mm): <input type="number" id="gap12" value="5"></label><br>
  <label>Gap 2-3 (mm): <input type="number" id="gap23" value="5"></label>
</div>

<!-- Preview container -->
<div id="allPreviews"></div>

<script>
const uploadLabel = document.getElementById('uploadLabel');
const previewBtn = document.getElementById('previewBtn');
const downloadBtn = document.getElementById('downloadBtn');
const submitBtn = document.getElementById('submitBtn');
const toggleAdvancedBtn = document.getElementById('toggleAdvanced');
const advancedOptions = document.getElementById('advancedOptions');
const allPreviews = document.getElementById('allPreviews');

let labelData = null;
const mmToPx = mm => Math.round(mm*3.78);

// Toggle advanced options
toggleAdvancedBtn.addEventListener('click', () => {
  const isVisible = advancedOptions.style.display === "block";
  advancedOptions.style.display = isVisible ? "none" : "block";
  toggleAdvancedBtn.textContent = isVisible ? "Show Advanced Options" : "Hide Advanced Options";
});

// Read JSON file
uploadLabel.addEventListener('change', e => {
  if(e.target.files.length > 0){
    const reader = new FileReader();
    reader.onload = ev => {
      try {
        labelData = JSON.parse(ev.target.result);
      } catch(err) {
        alert("Invalid JSON file");
      }
    };
    reader.readAsText(e.target.files[0]);
  }
});

// Draw single label to canvas
function drawLabelToCanvas(labelObj, params){
  const Wpx = mmToPx(params.canvas.width_mm);
  const Hpx = mmToPx(params.canvas.height_mm);
  const radius = mmToPx(params.canvas.corner_radius_mm);
  const circleRPx = mmToPx(params.canvas.circle_diameter_mm/2);
  const circleTopPx = mmToPx(params.canvas.circle_top_mm);
  const marginSidePx = mmToPx(params.canvas.margin_side_mm);
  const topExtraPx = mmToPx(params.canvas.top_margin_extra_mm);

  const textShiftPx = mmToPx(params.global.text_shift_mm || 0);
  const gap12Px = mmToPx(params.global.gap12_mm || 0);
  const gap23Px = mmToPx(params.global.linkGaps ? params.global.gap12_mm : params.global.gap23_mm || 0);

  const c = document.createElement('canvas');
  c.width = Wpx; c.height = Hpx;
  const ctx = c.getContext('2d');

  // Background
  ctx.fillStyle = '#000';
  ctx.beginPath();
  ctx.moveTo(radius,0); ctx.lineTo(Wpx-radius,0);
  ctx.quadraticCurveTo(Wpx,0,Wpx,radius);
  ctx.lineTo(Wpx,Hpx-radius);
  ctx.quadraticCurveTo(Wpx,Hpx,Wpx-radius,Hpx);
  ctx.lineTo(radius,Hpx);
  ctx.quadraticCurveTo(0,Hpx,0,Hpx-radius);
  ctx.lineTo(0,radius);
  ctx.quadraticCurveTo(0,0,radius,0);
  ctx.closePath();
  ctx.fill();

  // Circle
  ctx.beginPath();
  ctx.arc(Wpx/2, circleTopPx + circleRPx, circleRPx, 0, Math.PI*2);
  ctx.fillStyle = '#fff';
  ctx.fill();

  // Lines
  const lines = [];
  lines.push({...labelObj.lines.line1});
  if(labelObj.lines.line2?.text || labelObj.lines.line3?.text) lines.push({...labelObj.lines.line2});
  if(labelObj.lines.line3?.text) lines.push({...labelObj.lines.line3});

  let totalH = 0;
  lines.forEach((ln,i)=>{
    totalH += ln.size;
    if(i===0 && lines.length>1) totalH += gap12Px;
    if(i===1 && lines.length>2) totalH += gap23Px;
  });

  const topTextY = circleTopPx + circleRPx + topExtraPx + textShiftPx;
  const bottomY = Hpx - marginSidePx;
  const avail = bottomY - topTextY;
  let startY = topTextY + (avail-totalH)*0.55 + (lines.length>0?lines[0].size*0.75:0);

  ctx.fillStyle = '#fff';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'alphabetic';

  lines.forEach((ln,i)=>{
    let fontStr = '';
    if(ln.italic) fontStr+='italic ';
    if(ln.bold) fontStr+='bold ';
    fontStr += `${ln.size}px ${ln.font||'Arial'}`;
    ctx.font = fontStr;

    const maxWidth = Wpx - marginSidePx*2;
    const measured = ctx.measureText(ln.text).width;
    const scaleX = Math.min(1,maxWidth/measured);
    if(scaleX<1){
      ctx.save();
      ctx.translate(Wpx/2,startY);
      ctx.scale(scaleX,1);
      ctx.fillText(ln.text,0,0);
      ctx.restore();
    } else ctx.fillText(ln.text,Wpx/2,startY);

    if(i===0 && lines.length>1) startY += gap12Px + (lines[1]?.size || 0);
    else if(i===1 && lines.length>2) startY += gap23Px + (lines[2]?.size || 0);
  });

  return c;
}

// Create SVG
function createLabelSVG(labelObj, params){
  const W = params.canvas.width_mm * 3.78;
  const H = params.canvas.height_mm * 3.78;
  const radius = params.canvas.corner_radius_mm * 3.78;
  const circleRPx = params.canvas.circle_diameter_mm/2 * 3.78;
  const circleTopPx = params.canvas.circle_top_mm * 3.78;
  const marginSidePx = params.canvas.margin_side_mm * 3.78;
  const topExtraPx = params.canvas.top_margin_extra_mm * 3.78;
  const textShiftPx = (params.global.text_shift_mm || 0) * 3.78;
  const gap12Px = (params.global.gap12_mm || 0) * 3.78;
  const gap23Px = ((params.global.linkGaps ? params.global.gap12_mm : params.global.gap23_mm || 0) * 3.78);

  const lines = [];
  lines.push({...labelObj.lines.line1});
  if(labelObj.lines.line2?.text || labelObj.lines.line3?.text) lines.push({...labelObj.lines.line2});
  if(labelObj.lines.line3?.text) lines.push({...labelObj.lines.line3});

  let totalH = 0;
  lines.forEach((ln,i)=>{
    totalH += ln.size;
    if(i===0 && lines.length>1) totalH += gap12Px;
    if(i===1 && lines.length>2) totalH += gap23Px;
  });

  const topTextY = circleTopPx + circleRPx + topExtraPx + textShiftPx;
  const bottomY = H - marginSidePx;
  const avail = bottomY - topTextY;
  let startY = topTextY + (avail-totalH)*0.55 + (lines.length>0?lines[0].size*0.75:0);

  let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${W}" height="${H}">`;
  svg += `<rect x="0" y="0" width="${W}" height="${H}" rx="${radius}" ry="${radius}" fill="white" stroke="red" stroke-width="1"/>`;
  svg += `<circle cx="${W/2}" cy="${circleTopPx + circleRPx}" r="${circleRPx}" fill="none" stroke="red" stroke-width="1"/>`;

  lines.forEach((ln,i)=>{
    const maxWidth = W - marginSidePx*2;
    const temp = document.createElementNS("http://www.w3.org/2000/svg","text");
    temp.setAttribute("font-size", ln.size);
    temp.setAttribute("font-family", ln.font||"Arial");
    temp.textContent = ln.text;
    document.body.appendChild(temp);
    const measuredWidth = temp.getBBox().width;
    document.body.removeChild(temp);
    const scaleX = Math.min(1,maxWidth/measuredWidth);

    svg += `<text x="${W/2}" y="${startY}" font-family="${ln.font||'Arial'}" font-size="${ln.size}" fill="blue" font-weight="${ln.bold?'bold':'normal'}" font-style="${ln.italic?'italic':'normal'}" text-anchor="middle" dominant-baseline="alphabetic" transform="translate(${W/2},${startY}) scale(${scaleX},1)">${ln.text}</text>`;

    if(i===0 && lines.length>1) startY += gap12Px + (lines[1]?.size || 0);
    else if(i===1 && lines.length>2) startY += gap23Px + (lines[2]?.size || 0);
  });

  svg += `</svg>`;
  return svg;
}

// Preview Labels (one copy each)
function previewLabels(){
  if(!labelData) return alert("Upload JSON first");
  allPreviews.innerHTML = '';
  labelData.labels.forEach(lbl=>{
    const header = document.createElement('div');
    header.textContent = `${lbl.name} - ${lbl.qty || 1} copies`;
    header.style.fontWeight = 'bold';
    allPreviews.appendChild(header);
    const canvas = drawLabelToCanvas(lbl,labelData);
    allPreviews.appendChild(canvas);
  });
}

// Download SVGs as ZIP
function downloadSVGs(){
  if(!labelData) return alert("Upload JSON first");
  const zip = new JSZip();
  labelData.labels.forEach(lbl=>{
    const svg = createLabelSVG(lbl,labelData);
    zip.file(`${lbl.name}_${lbl.qty}copies.svg`, svg);
  });
  zip.generateAsync({type:"blob"}).then(content=>{
    const a = document.createElement('a');
    a.href = URL.createObjectURL(content);
    a.download = "labels.zip";
    a.click();
  });
}

// Submit to Google Sheet
function submitToGoogleSheet(){
  const name = document.getElementById("name").value;
  const email = document.getElementById("email").value;
  if(!name || !email) return alert("Enter name and email");

  const data = labelData;
  if(!data) return alert("Upload JSON first");

  fetch("https://script.google.com/macros/s/AKfycbzf_fy7C2FjvF-iQ6ZVq8lBjkXy8PZFifZ1D0-oqQG33ZEq1FxKWIjTtN7JF0rFSt4j/exec",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify({name,email,data})
  })
  .then(res=>res.json())
  .then(resp=>alert(`Submission successful! Reference: ${resp.reference}`))
  .catch(err=>alert("Submission failed: "+err));
}

// Event listeners
previewBtn.addEventListener('click',previewLabels);
downloadBtn.addEventListener('click',downloadSVGs);
submitBtn.addEventListener('click',submitToGoogleSheet);

</script>
</body>
</html>


